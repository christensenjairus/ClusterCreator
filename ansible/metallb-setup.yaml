- name: Install MetalLB on Kubernetes Cluster
  hosts: apiserver[0]
  gather_facts: false
  tags:
    - metallb_basic_install
  vars:
    cluster_config: "{{ lookup('file', 'tmp/{{ cluster_name }}/cluster_config.json') | from_json }}"
  tasks:

    - name: Generate MetalLB configuration files
      become: yes
      ansible.builtin.template:
        src: helpers/metallb_configs.yaml.j2
        dest: "/tmp/metallb_configs.yaml"
      vars:
        ipv4_lb_cidrs: "{{ cluster_config.networking.ipv4.lb_cidrs }}"
        ipv6_lb_cidrs: "{{ cluster_config.networking.ipv6.lb_cidrs }}"
      tags:
        - metallb_configs

    - name: Add MetalLB Helm repository
      ansible.builtin.shell:
        cmd: helm repo add metallb https://metallb.github.io/metallb
      args:
        executable: /bin/bash

    - name: Update Helm repositories
      ansible.builtin.shell:
        cmd: helm repo update
      args:
        executable: /bin/bash

    - name: Install MetalLB
      ansible.builtin.shell:
        cmd: >
          helm upgrade --install metallb metallb/metallb
          --namespace metallb-system
          --create-namespace
          --version v{{ metallb_version }}
      args:
        executable: /bin/bash

    - name: Wait for MetalLB controller deployment to be ready
      ansible.builtin.shell:
        cmd: kubectl rollout status deployment/metallb-controller --namespace metallb-system --timeout=300s
      args:
        executable: /bin/bash
      tags:
        - metallb_wait

    - name: Apply MetalLB configuration files
      ansible.builtin.shell:
        cmd: kubectl apply -f /tmp/metallb_configs.yaml
      args:
        executable: /bin/bash
      tags:
          - metallb_configs_apply